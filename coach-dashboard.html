<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard - Macro Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Supabase Authentication System -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="production-config.js"></script>
    <script src="supabase-init.js"></script>
    <script src="simple-auth-modal.js"></script>
    
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }
        .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        .macro-progress {
            transition: all 0.3s ease;
        }
        
        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .mobile-header {
                padding: 1rem;
            }
            
            .mobile-card {
                margin: 0.5rem;
                border-radius: 1rem;
            }
            
            .mobile-stats {
                padding: 1rem;
            }
            
            .mobile-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .mobile-text {
                font-size: 0.875rem;
                line-height: 1.25;
            }
            
            .client-card {
                margin-bottom: 1rem;
            }
        }
        
        /* Touch-friendly interactions */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        @media (hover: none) and (pointer: coarse) {
            .client-card:hover {
                transform: none;
            }
            
            .client-card:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }
        
        /* View Toggle Dropdown Styles */
        .dropdown-enter {
            transform: translateY(-10px);
            opacity: 0;
        }
        
        .dropdown-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.2s ease;
        }
        
        /* Improved mobile table scrolling */
        .mobile-table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Unified admin/coach styling */
        .unified-view {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Authentication Check -->
    <div id="auth-check" class="fixed inset-0 bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center z-50 p-4 sm:p-6">
        <div class="relative bg-white/95 backdrop-blur-lg rounded-2xl sm:rounded-3xl shadow-2xl border border-white/20 p-6 sm:p-8 max-w-sm sm:max-w-lg w-full mx-2 sm:mx-4 mobile-card">
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full mb-4">
                    <i class="fas fa-dumbbell text-2xl sm:text-3xl text-blue-600"></i>
                </div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Coach Access Required</h2>
                <p class="text-base sm:text-lg text-gray-600 mb-6">Please login to access your coaching dashboard</p>
                
                <div id="auth-loading" class="hidden">
                    <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-blue-600 rounded-full mb-4"></div>
                    <p class="text-gray-600">Authenticating...</p>
                </div>
                
                <div id="auth-actions" class="space-y-4">
                    <button onclick="requestCoachLogin()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 touch-target active:scale-95">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Login as Coach
                    </button>
                </div>
                
                <div id="auth-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-4 text-sm sm:text-base">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4 mobile-header">
                <div class="flex justify-between items-center">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-900 truncate">
                            <i class="fas fa-dumbbell text-blue-600 mr-2 sm:mr-3"></i>
                            <span id="coach-title" class="hidden sm:inline">Coach Dashboard</span>
                            <span id="coach-title-mobile" class="sm:hidden">Coach</span>
                        </h1>
                        <p class="text-gray-600 mt-1 text-sm hidden sm:block">Monitor your clients' macro nutrition progress</p>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-right hidden sm:block">
                            <div class="text-sm font-medium text-gray-900" id="coach-name">Coach</div>
                            <div class="text-xs text-gray-600" id="coach-email"></div>
                        </div>
                        <!-- View Toggle Menu -->
                        <div class="flex items-center space-x-2">
                            <div class="relative">
                                <button id="view-toggle-btn" onclick="toggleViewMenu()" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors text-sm touch-target flex items-center">
                                    <i class="fas fa-th-list mr-1 sm:mr-2"></i>
                                    <span class="hidden sm:inline">View</span>
                                    <i class="fas fa-chevron-down ml-1 sm:ml-2 text-xs"></i>
                                </button>
                                
                                <!-- Dropdown Menu -->
                                <div id="view-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                                    <div class="py-2">
                                        <button onclick="switchToCoachView()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors flex items-center">
                                            <i class="fas fa-dumbbell mr-3 text-blue-600"></i>
                                            Coach Dashboard
                                        </button>
                                        <button onclick="switchToAdminView()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors flex items-center">
                                            <i class="fas fa-users mr-3 text-purple-600"></i>
                                            User Management
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="coachLogout()" class="bg-red-600 text-white px-3 py-2 sm:px-4 rounded-lg hover:bg-red-700 transition-colors text-sm sm:text-base touch-target">
                                <i class="fas fa-sign-out-alt mr-1 sm:mr-2"></i>
                                <span class="hidden sm:inline">Logout</span>
                                <span class="sm:hidden">Exit</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile coach info -->
                <div class="mt-2 sm:hidden">
                    <div class="text-xs font-medium text-gray-900" id="coach-name-mobile"></div>
                    <div class="text-xs text-gray-600" id="coach-email-mobile"></div>
                </div>
            </div>
        </header>

        <!-- Coach Stats Overview -->
        <div id="coach-view" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-blue-100 rounded-full flex-shrink-0">
                            <i class="fas fa-users text-blue-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">My Clients</p>
                            <p id="stat-client-count" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-green-100 rounded-full flex-shrink-0">
                            <i class="fas fa-bullseye text-green-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">On Track</p>
                            <p id="stat-on-track" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats col-span-2 sm:col-span-1">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-yellow-100 rounded-full flex-shrink-0">
                            <i class="fas fa-utensils text-yellow-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Meals Today</p>
                            <p id="stat-meals-today" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-3 sm:p-6 mobile-stats col-span-2 sm:col-span-1">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-purple-100 rounded-full flex-shrink-0">
                            <i class="fas fa-chart-line text-purple-600 text-sm sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Avg. Adherence</p>
                            <p id="stat-avg-adherence" class="text-lg sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invitation Codes Section -->
            <div class="bg-white rounded-lg shadow mb-4 sm:mb-6 p-4 sm:p-6">
                <div class="flex flex-col space-y-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0 mb-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Invitation Codes</h3>
                        <p class="text-sm text-gray-600">Share these codes with clients to automatically assign them to you</p>
                    </div>
                    <button onclick="generateInvitationCode()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm sm:text-base touch-target">
                        <i class="fas fa-plus mr-2"></i>Generate Code
                    </button>
                </div>
                
                <!-- Invitation Codes List -->
                <div id="invitation-codes-container">
                    <div id="invitation-codes-loading" class="text-center py-4 hidden">
                        <div class="animate-spin inline-block w-6 h-6 border-[2px] border-current border-t-transparent text-blue-600 rounded-full"></div>
                        <p class="text-sm text-gray-600 mt-2">Loading invitation codes...</p>
                    </div>
                    
                    <div id="invitation-codes-empty" class="text-center py-8 text-gray-500 hidden">
                        <i class="fas fa-ticket-alt text-3xl mb-3"></i>
                        <p>No invitation codes yet. Generate one to start inviting clients!</p>
                    </div>
                    
                    <div id="invitation-codes-list" class="space-y-3">
                        <!-- Invitation codes will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Date Filter -->
            <div class="bg-white rounded-lg shadow mb-4 sm:mb-6 p-4 sm:p-6"></div>
                <div class="flex flex-col space-y-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
                    <h3 class="text-lg font-medium text-gray-900">Client Macro Progress</h3>
                    <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:items-center sm:space-x-4">
                        <div class="flex items-center">
                            <label for="date-filter" class="text-sm text-gray-600 mr-2 whitespace-nowrap">Date:</label>
                            <input type="date" id="date-filter" 
                                   class="flex-1 sm:flex-none border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-target"
                                   onchange="filterByDate()">
                        </div>
                        <button onclick="refreshClients()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm touch-target">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="text-center py-12">
                <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 rounded-full mb-4"></div>
                <p class="text-gray-600">Loading client data...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden bg-white rounded-lg shadow p-8 text-center">
                <div class="inline-block p-3 bg-red-100 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Client Data</h3>
                <p id="error-message" class="text-gray-600 mb-4">Failed to load client macro data</p>
                <button onclick="refreshClients()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Try Again
                </button>
            </div>

            <!-- Clients Grid -->
            <div id="clients-container" class="hidden">
                <div id="clients-grid" class="grid grid-cols-1 sm:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 sm:gap-6 mobile-grid">
                    <!-- Client cards will be populated here -->
                </div>
            </div>

            <!-- No Clients State -->
            <div id="no-clients-state" class="hidden bg-white rounded-lg shadow p-8 text-center">
                <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                    <i class="fas fa-users text-2xl text-gray-400"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Clients Assigned</h3>
                <p class="text-gray-600">You don't have any clients assigned to you yet. Contact your admin to get started.</p>
            </div>
        </div>
        </div>
        
        <!-- Admin User Management View -->
        <div id="admin-view" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
            <!-- Admin Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-stats">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-blue-100 rounded-lg flex-shrink-0">
                            <i class="fas fa-users text-blue-600 text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Total Users</p>
                            <p id="admin-stat-total-users" class="text-xl sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-stats">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-green-100 rounded-lg flex-shrink-0">
                            <i class="fas fa-user-check text-green-600 text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Active Users</p>
                            <p id="admin-stat-active-users" class="text-xl sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-stats sm:col-span-2 lg:col-span-1">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 bg-purple-100 rounded-lg flex-shrink-0">
                            <i class="fas fa-clock text-purple-600 text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Recent Activity</p>
                            <p id="admin-stat-recent-activity" class="text-xl sm:text-2xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="bg-white rounded-lg shadow mb-4 sm:mb-6">
                <div class="p-4 sm:p-6 border-b border-gray-200">
                    <div class="flex flex-col space-y-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
                        <h3 class="text-lg font-medium text-gray-900">User Management</h3>
                        <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:space-x-4">
                            <div class="relative flex-1 sm:flex-none">
                                <input type="text" id="admin-search-input" placeholder="Search users..." 
                                       class="w-full sm:w-auto pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base touch-target">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button onclick="refreshAdminUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm sm:text-base touch-target">
                                <i class="fas fa-sync-alt mr-2"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="admin-loading" class="p-8 text-center hidden">
                    <div class="animate-spin inline-block w-8 h-8 border-[3px] border-current border-t-transparent text-blue-600 rounded-full mb-4"></div>
                    <p class="text-gray-600">Loading users...</p>
                </div>

                <!-- Error State -->
                <div id="admin-error-state" class="hidden p-8 text-center">
                    <div class="inline-block p-3 bg-red-100 rounded-full mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Data</h3>
                    <p id="admin-error-message" class="text-gray-600 mb-4">Failed to load user data</p>
                    <button onclick="refreshAdminUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Try Again
                    </button>
                </div>

                <!-- Users Table/Cards -->
                <div id="admin-users-container" class="hidden">
                    <!-- Desktop Table -->
                    <div class="hidden sm:block overflow-x-auto mobile-table-scroll">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Activity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mobile Cards -->
                    <div class="sm:hidden space-y-3">
                        <div id="admin-mobile-users-container">
                            <!-- Mobile user cards will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="admin-empty-state" class="hidden p-8 text-center">
                    <div class="inline-block p-3 bg-gray-100 rounded-full mb-4">
                        <i class="fas fa-users text-2xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Users Found</h3>
                    <p class="text-gray-600">No users match your current search criteria</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Secure configuration
        const secureRoles = window.getSecureRoles();

        let currentUser = null;
        let currentUserRole = null;
        let clientsData = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentView = 'coach'; // 'coach' or 'admin'
        let allUsers = [];
        let filteredUsers = [];

        // Initialize date filter to today
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('date-filter').value = selectedDate;
        });

        // Authentication functions
        async function requestCoachLogin() {
            document.getElementById('auth-loading').classList.remove('hidden');
            document.getElementById('auth-actions').classList.add('hidden');
            document.getElementById('auth-error').classList.add('hidden');
            
            try {
                if (window.simpleAuth) {
                    window.simpleAuth.open((user) => {
                        // Load coach dashboard
                        loadCoachDashboard();
                    });
                } else {
                    throw new Error('Authentication system not available');
                }
            } catch (error) {
                showAuthError('Authentication system error: ' + error.message);
            }
        }

        function showAuthError(message) {
            document.getElementById('auth-error').textContent = message;
            document.getElementById('auth-error').classList.remove('hidden');
            document.getElementById('auth-loading').classList.add('hidden');
            document.getElementById('auth-actions').classList.remove('hidden');
        }

        async function verifyCoachAccess() {
            try {
                if (!window.supabaseClient) {
                    console.error('Supabase client not available');
                    return false;
                }

                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                
                if (error) {
                    console.error('Auth error:', error);
                    return false;
                }

                if (!user) {
                    console.log('No user logged in');
                    return false;
                }

                // Get user role using new role system
                const userRole = await getUserRoleInfo(user.email);
                
                if (!userRole || !['coach', 'owner', 'admin'].includes(userRole.user_role)) {
                    showAuthError('Access denied. Coach, Owner, or Admin privileges required.');
                    return false;
                }

                currentUser = user;
                currentUserRole = {
                    role: userRole.user_role,
                    display_name: userRole.display_name || user.email,
                    permissions: userRole.permissions,
                    can_invite_clients: userRole.can_invite_clients,
                    can_manage_users: userRole.can_manage_users,
                    can_access_analytics: userRole.can_access_analytics,
                    can_generate_codes: userRole.can_generate_codes
                };
                
                return true;

            } catch (error) {
                console.error('Error verifying coach access:', error);
                showAuthError('Authentication error: ' + error.message);
                return false;
            }
        }

        async function coachLogout() {
            try {
                if (window.supabaseClient) {
                    await window.supabaseClient.auth.signOut();
                }
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
                window.location.reload();
            }
        }

        // Get user role information using new role system
        async function getUserRoleInfo(email) {
            try {
                const { data, error } = await window.supabaseClient
                    .rpc('get_user_role_info', { user_email: email });

                if (error) {
                    console.error('Error getting user role info:', error);
                    return null;
                }

                return data && data.length > 0 ? data[0] : null;

            } catch (error) {
                console.error('Error in getUserRoleInfo:', error);
                return null;
            }
        }

        // Data fetching functions
        async function fetchAssignedClients() {
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not available');
                }

                let query = window.supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Apply role-based filtering
                if (currentUserRole.role === 'coach') {
                    query = query.eq('assigned_coach', currentUser.email);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    throw error;
                }
                
                return data || [];
                
            } catch (error) {
                throw error;
            }
        }

        async function fetchClientMacrosForDate(clientEmail, date) {
            try {
                
                // Fetch daily meals for the specific date
                const { data: mealsData, error: mealsError } = await window.supabaseClient
                    .from('daily_meals')
                    .select('*')
                    .eq('user_email', clientEmail)
                    .gte('created_at', date + 'T00:00:00')
                    .lt('created_at', date + 'T23:59:59');
                
                if (mealsError) {
                    return null;
                }

                // Fetch daily targets for comparison
                const { data: targetsData, error: targetsError } = await window.supabaseClient
                    .from('daily_targets')
                    .select('*')
                    .eq('user_email', clientEmail)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (targetsError) {
                    // Targets fetch failed, use defaults
                }

                // Calculate totals from meals
                const macroTotals = (mealsData || []).reduce((totals, meal) => {
                    return {
                        calories: totals.calories + (parseFloat(meal.calories) || 0),
                        protein: totals.protein + (parseFloat(meal.protein) || 0),
                        carbs: totals.carbs + (parseFloat(meal.carbs) || 0),
                        fat: totals.fat + (parseFloat(meal.fat) || 0)
                    };
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

                const targets = targetsData && targetsData.length > 0 ? {
                    calories: parseFloat(targetsData[0].daily_calories) || 2000,
                    protein: parseFloat(targetsData[0].daily_protein) || 150,
                    carbs: parseFloat(targetsData[0].daily_carbs) || 200,
                    fat: parseFloat(targetsData[0].daily_fat) || 65
                } : { calories: 2000, protein: 150, carbs: 200, fat: 65 };

                return {
                    consumed: macroTotals,
                    targets: targets,
                    mealsCount: mealsData ? mealsData.length : 0
                };
                
            } catch (error) {
                return null;
            }
        }

        // Main load function
        async function loadCoachDashboard() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('error-state').classList.add('hidden');
                document.getElementById('clients-container').classList.add('hidden');
                document.getElementById('no-clients-state').classList.add('hidden');

                // Verify coach access
                const hasAccess = await verifyCoachAccess();
                if (!hasAccess) {
                    document.getElementById('auth-check').classList.remove('hidden');
                    return;
                }

                // Update coach info in header
                if (currentUser && currentUserRole) {
                    document.getElementById('coach-title').textContent = `${currentUserRole.display_name} Dashboard`;
                    document.getElementById('coach-title-mobile').textContent = currentUserRole.display_name;
                    document.getElementById('coach-name').textContent = currentUserRole.display_name;
                    document.getElementById('coach-email').textContent = currentUser.email;
                    document.getElementById('coach-name-mobile').textContent = currentUserRole.display_name;
                    document.getElementById('coach-email-mobile').textContent = currentUser.email;
                }

                // Fetch assigned clients
                const clients = await fetchAssignedClients();
                
                if (clients.length === 0) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('no-clients-state').classList.remove('hidden');
                    updateStats([], []);
                    return;
                }

                clientsData = clients;

                // Fetch macro data for each client
                const clientsWithMacros = [];
                for (const client of clients) {
                    const clientEmail = client.user_email || client.email;
                    if (clientEmail) {
                        const macroData = await fetchClientMacrosForDate(clientEmail, selectedDate);
                        clientsWithMacros.push({
                            ...client,
                            macros: macroData
                        });
                    }
                }

                displayClients(clientsWithMacros);
                updateStats(clients, clientsWithMacros);

                // Load invitation codes
                loadInvitationCodes();

                // Hide auth screen and show dashboard
                document.getElementById('auth-check').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

            } catch (error) {
                showError('Failed to load coach dashboard');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayClients(clientsWithMacros) {
            const grid = document.getElementById('clients-grid');
            grid.innerHTML = '';

            if (clientsWithMacros.length === 0) {
                document.getElementById('clients-container').classList.add('hidden');
                document.getElementById('no-clients-state').classList.remove('hidden');
                return;
            }

            document.getElementById('clients-container').classList.remove('hidden');
            document.getElementById('no-clients-state').classList.add('hidden');

            clientsWithMacros.forEach(client => {
                const card = createClientCard(client);
                grid.appendChild(card);
            });
        }

        function createClientCard(client) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow client-card transition-all duration-300 p-6';
            
            const clientName = client.user_name || 'Unknown User';
            const clientEmail = client.user_email || client.email || 'No email';
            const macros = client.macros;
            
            if (!macros) {
                div.innerHTML = `
                    <div class="text-center py-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${clientName}</h3>
                        <p class="text-sm text-gray-600 mb-4">${clientEmail}</p>
                        <div class="text-gray-500">
                            <i class="fas fa-exclamation-circle mb-2"></i>
                            <p>No data available</p>
                        </div>
                    </div>
                `;
                return div;
            }

            const { consumed, targets, mealsCount } = macros;
            
            // Calculate percentages
            const caloriesPercent = Math.min((consumed.calories / targets.calories) * 100, 100);
            const proteinPercent = Math.min((consumed.protein / targets.protein) * 100, 100);
            const carbsPercent = Math.min((consumed.carbs / targets.carbs) * 100, 100);
            const fatPercent = Math.min((consumed.fat / targets.fat) * 100, 100);
            
            // Calculate adherence score
            const adherence = Math.round((caloriesPercent + proteinPercent + carbsPercent + fatPercent) / 4);
            const adherenceColor = adherence >= 80 ? 'text-green-600' : adherence >= 60 ? 'text-yellow-600' : 'text-red-600';
            const adherenceBg = adherence >= 80 ? 'bg-green-100' : adherence >= 60 ? 'bg-yellow-100' : 'bg-red-100';

            div.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="min-w-0 flex-1">
                        <h3 class="text-base sm:text-lg font-semibold text-gray-900 truncate">${clientName}</h3>
                        <p class="text-xs sm:text-sm text-gray-600 truncate">${clientEmail}</p>
                    </div>
                    <div class="text-center flex-shrink-0 ml-3">
                        <div class="px-2 sm:px-3 py-1 rounded-full ${adherenceBg} ${adherenceColor} text-xs sm:text-sm font-medium">
                            ${adherence}%
                        </div>
                        <p class="text-xs text-gray-500 mt-1 hidden sm:block">Adherence</p>
                    </div>
                </div>
                
                <div class="space-y-2 sm:space-y-3">
                    <!-- Calories -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">Calories</span>
                            <span class="text-xs sm:text-sm text-gray-600">${Math.round(consumed.calories)} / ${Math.round(targets.calories)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full macro-progress" style="width: ${caloriesPercent}%"></div>
                        </div>
                    </div>
                    
                    <!-- Protein -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">Protein</span>
                            <span class="text-xs sm:text-sm text-gray-600">${Math.round(consumed.protein)}g / ${Math.round(targets.protein)}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full macro-progress" style="width: ${proteinPercent}%"></div>
                        </div>
                    </div>
                    
                    <!-- Carbs -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">Carbs</span>
                            <span class="text-xs sm:text-sm text-gray-600">${Math.round(consumed.carbs)}g / ${Math.round(targets.carbs)}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-yellow-600 h-2 rounded-full macro-progress" style="width: ${carbsPercent}%"></div>
                        </div>
                    </div>
                    
                    <!-- Fat -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs sm:text-sm font-medium text-gray-700">Fat</span>
                            <span class="text-xs sm:text-sm text-gray-600">${Math.round(consumed.fat)}g / ${Math.round(targets.fat)}g</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-600 h-2 rounded-full macro-progress" style="width: ${fatPercent}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center min-w-0 flex-1">
                            <i class="fas fa-utensils text-gray-400 mr-2 flex-shrink-0"></i>
                            <span class="text-xs sm:text-sm text-gray-600 truncate">${mealsCount} meals logged</span>
                        </div>
                        <button onclick="viewClientDetails('${clientEmail}')" class="text-blue-600 hover:text-blue-800 text-xs sm:text-sm font-medium ml-3 px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors touch-target">
                            <span class="hidden sm:inline">View Details</span>
                            <span class="sm:hidden">Details</span>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        function updateStats(clients, clientsWithMacros) {
            document.getElementById('stat-client-count').textContent = clients.length;
            
            if (clientsWithMacros.length === 0) {
                document.getElementById('stat-on-track').textContent = '0';
                document.getElementById('stat-meals-today').textContent = '0';
                document.getElementById('stat-avg-adherence').textContent = '0%';
                return;
            }
            
            let onTrackCount = 0;
            let totalMeals = 0;
            let totalAdherence = 0;
            let validClients = 0;
            
            clientsWithMacros.forEach(client => {
                if (client.macros) {
                    const { consumed, targets, mealsCount } = client.macros;
                    
                    // Calculate adherence
                    const caloriesPercent = Math.min((consumed.calories / targets.calories) * 100, 100);
                    const proteinPercent = Math.min((consumed.protein / targets.protein) * 100, 100);
                    const carbsPercent = Math.min((consumed.carbs / targets.carbs) * 100, 100);
                    const fatPercent = Math.min((consumed.fat / targets.fat) * 100, 100);
                    
                    const adherence = (caloriesPercent + proteinPercent + carbsPercent + fatPercent) / 4;
                    
                    if (adherence >= 80) onTrackCount++;
                    totalMeals += mealsCount;
                    totalAdherence += adherence;
                    validClients++;
                }
            });
            
            document.getElementById('stat-on-track').textContent = onTrackCount;
            document.getElementById('stat-meals-today').textContent = totalMeals;
            document.getElementById('stat-avg-adherence').textContent = validClients > 0 ? 
                Math.round(totalAdherence / validClients) + '%' : '0%';
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('clients-container').classList.add('hidden');
        }

        // View switching functions
        function toggleViewMenu() {
            const dropdown = document.getElementById('view-dropdown');
            dropdown.classList.toggle('hidden');
        }
        
        function switchToCoachView() {
            currentView = 'coach';
            document.getElementById('coach-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('view-dropdown').classList.add('hidden');
            
            // Update header title
            if (currentUserRole) {
                document.getElementById('coach-title').textContent = `${currentUserRole.display_name} Dashboard`;
                document.getElementById('coach-title-mobile').textContent = currentUserRole.display_name;
            }
        }
        
        function switchToAdminView() {
            currentView = 'admin';
            document.getElementById('coach-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('view-dropdown').classList.add('hidden');
            
            // Update header title
            document.getElementById('coach-title').textContent = 'User Management Dashboard';
            document.getElementById('coach-title-mobile').textContent = 'User Management';
            
            // Load admin data
            loadAdminUsers();
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('view-dropdown');
            const button = document.getElementById('view-toggle-btn');
            
            if (dropdown && button && !button.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Admin Users Management Functions
        async function loadAdminUsers() {
            try {
                document.getElementById('admin-loading').classList.remove('hidden');
                document.getElementById('admin-error-state').classList.add('hidden');
                document.getElementById('admin-users-container').classList.add('hidden');
                document.getElementById('admin-empty-state').classList.add('hidden');

                // Fetch user profiles using the same function as coach dashboard
                const userData = await fetchAllUserProfiles();
                
                if (userData.length === 0) {
                    document.getElementById('admin-loading').classList.add('hidden');
                    document.getElementById('admin-empty-state').classList.remove('hidden');
                    return;
                }

                allUsers = userData;
                
                // Apply role-based filtering (same as coach dashboard logic)
                allUsers = filterUsersByRole(allUsers);
                
                filteredUsers = [...allUsers];
                displayAdminUsers();
                updateAdminStatistics();

            } catch (error) {
                showAdminError('Failed to load user data');
            } finally {
                document.getElementById('admin-loading').classList.add('hidden');
            }
        }
        
        async function fetchAllUserProfiles() {
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not available');
                }

                let query = window.supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                const { data, error } = await query;
                
                if (error) {
                    throw error;
                }
                
                return data || [];
                
            } catch (error) {
                throw error;
            }
        }
        
        function displayAdminUsers() {
            const tbody = document.getElementById('admin-users-tbody');
            const mobileContainer = document.getElementById('admin-mobile-users-container');
            tbody.innerHTML = '';
            mobileContainer.innerHTML = '';

            if (filteredUsers.length === 0) {
                document.getElementById('admin-users-container').classList.add('hidden');
                document.getElementById('admin-empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('admin-users-container').classList.remove('hidden');
            document.getElementById('admin-empty-state').classList.add('hidden');

            filteredUsers.forEach(user => {
                // Desktop table row
                const row = createAdminUserRow(user);
                tbody.appendChild(row);
                
                // Mobile card
                const card = createAdminMobileUserCard(user);
                mobileContainer.appendChild(card);
            });
        }
        
        function createAdminUserRow(user) {
            const tr = document.createElement('tr');
            
            const userEmail = user.user_email || user.email || 'No email';
            const userName = user.user_name || user.name || 'Unknown User';
            const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
            const lastActivity = user.lastActivity ? formatTimeAgo(user.lastActivity) : 'No activity';
            const status = user.assignment_status || 'unassigned';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                <i class="fas fa-user text-gray-600"></i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${userName}</div>
                            <div class="text-sm text-gray-500">${userEmail}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadgeClass(status)}">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${joinDate}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${lastActivity}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewAdminUser('${user.id || userEmail}')" class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-eye mr-1"></i>View
                    </button>
                </td>
            `;
            
            return tr;
        }
        
        function createAdminMobileUserCard(user) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4 border border-gray-200';
            
            const userEmail = user.user_email || user.email || 'No email';
            const userName = user.user_name || user.name || 'Unknown User';
            const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
            const lastActivity = user.lastActivity ? formatTimeAgo(user.lastActivity) : 'No activity';
            const status = user.assignment_status || 'unassigned';
            
            div.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="flex-shrink-0 h-10 w-10 bg-gray-300 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-gray-600 text-sm"></i>
                        </div>
                        <div class="ml-3 min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900 truncate">${userName}</p>
                            <p class="text-xs text-gray-500 truncate">${userEmail}</p>
                        </div>
                    </div>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(status)}">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-xs text-gray-500 mb-3">
                    <div>
                        <span class="font-medium text-gray-700">Joined:</span><br>
                        ${joinDate}
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Last Active:</span><br>
                        ${lastActivity}
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button onclick="viewAdminUser('${user.id || userEmail}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium touch-target px-3 py-2 rounded-lg hover:bg-blue-50 transition-colors">
                        <i class="fas fa-eye mr-1"></i>View Details
                    </button>
                </div>
            `;
            
            return div;
        }
        
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'coach': return 'bg-blue-100 text-blue-800';
                case 'owner': return 'bg-purple-100 text-purple-800';
                case 'unassigned': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Utility function for time formatting
        function formatTimeAgo(date) {
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Just now';
            if (diffInHours < 24) return `${diffInHours}h ago`;
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 30) return `${diffInDays}d ago`;
            return date.toLocaleDateString();
        }
        
        // Role-based data filtering function
        function filterUsersByRole(users) {
            if (!currentUserRole) {
                return [];
            }

            // Owner can see all users
            if (currentUserRole.role === 'owner') {
                return users;
            }

            // Coach can only see their assigned clients
            if (currentUserRole.role === 'coach') {
                const coachEmail = currentUser.email;
                
                const assignedUsers = users.filter(user => {
                    const assignedCoach = user.assigned_coach;
                    return assignedCoach === coachEmail;
                });
                
                return assignedUsers;
            }

            // Unknown role
            return [];
        }
        
        function updateAdminStatistics() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(u => u.lastActivity && u.lastActivity > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
            const recentActivity = allUsers.filter(u => u.lastActivity && u.lastActivity > new Date(Date.now() - 24 * 60 * 60 * 1000)).length;

            document.getElementById('admin-stat-total-users').textContent = totalUsers;
            document.getElementById('admin-stat-active-users').textContent = activeUsers;
            document.getElementById('admin-stat-recent-activity').textContent = recentActivity;
        }
        
        function showAdminError(message) {
            document.getElementById('admin-error-message').textContent = message;
            document.getElementById('admin-error-state').classList.remove('hidden');
            document.getElementById('admin-loading').classList.add('hidden');
            document.getElementById('admin-users-container').classList.add('hidden');
        }
        
        function refreshAdminUsers() {
            if (currentView === 'admin') {
                loadAdminUsers();
            }
        }
        
        function viewAdminUser(userId) {
            // Placeholder for user detail view
            alert('User detail view - Feature coming soon!');
        }
        
        // Admin search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const adminSearchInput = document.getElementById('admin-search-input');
            if (adminSearchInput) {
                adminSearchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    if (query === '') {
                        filteredUsers = [...allUsers];
                    } else {
                        filteredUsers = allUsers.filter(user => {
                            const email = (user.user_email || user.email || '').toLowerCase();
                            const name = (user.user_name || user.name || '').toLowerCase();
                            return email.includes(query) || name.includes(query);
                        });
                    }
                    displayAdminUsers();
                    updateAdminStatistics();
                });
            }
        });

        // Utility functions
        function refreshClients() {
            if (currentView === 'coach') {
                loadCoachDashboard();
            } else {
                loadAdminUsers();
            }
        }

        function filterByDate() {
            selectedDate = document.getElementById('date-filter').value;
            loadCoachDashboard();
        }

        function viewClientDetails(clientEmail) {
            // Placeholder for client detail view
            alert('Client detail view - Feature coming soon!');
        }

        // Invitation Codes Management Functions
        async function generateInvitationCode() {
            try {
                if (!currentUser || !currentUserRole) {
                    alert('Please log in first');
                    return;
                }

                // Generate a unique 8-character code
                const code = generateRandomCode();
                const codeId = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString();

                // Create invitation code record
                const invitationData = {
                    id: codeId,
                    code: code,
                    coach_email: currentUser.email,
                    coach_name: currentUserRole.display_name,
                    created_at: Date.now(),
                    expires_at: null, // No expiration by default
                    usage_count: 0,
                    max_uses: 0, // Unlimited uses
                    is_active: true,
                    description: `Generated by ${currentUserRole.display_name}`
                };

                // Save to database
                const { error } = await window.supabaseClient
                    .from('invite_codes')
                    .insert([invitationData]);

                if (error) {
                    throw error;
                }

                // Reload invitation codes
                loadInvitationCodes();
                
                // Show success message
                alert(`Invitation code "${code}" generated successfully! Share this code with clients.`);

            } catch (error) {
                console.error('Error generating invitation code:', error);
                alert('Failed to generate invitation code. Please try again.');
            }
        }

        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function loadInvitationCodes() {
            if (!currentUser) return;

            try {
                document.getElementById('invitation-codes-loading').classList.remove('hidden');
                document.getElementById('invitation-codes-empty').classList.add('hidden');
                document.getElementById('invitation-codes-list').classList.add('hidden');

                const { data, error } = await window.supabaseClient
                    .from('invite_codes')
                    .select('*')
                    .eq('coach_email', currentUser.email)
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                document.getElementById('invitation-codes-loading').classList.add('hidden');

                if (!data || data.length === 0) {
                    document.getElementById('invitation-codes-empty').classList.remove('hidden');
                    return;
                }

                displayInvitationCodes(data);
                document.getElementById('invitation-codes-list').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading invitation codes:', error);
                document.getElementById('invitation-codes-loading').classList.add('hidden');
                document.getElementById('invitation-codes-empty').classList.remove('hidden');
            }
        }

        function displayInvitationCodes(codes) {
            const container = document.getElementById('invitation-codes-list');
            container.innerHTML = '';

            codes.forEach(code => {
                const codeElement = createInvitationCodeElement(code);
                container.appendChild(codeElement);
            });
        }

        function createInvitationCodeElement(code) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 rounded-lg p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between border border-gray-200';

            const createdDate = new Date(code.created_at).toLocaleDateString();
            
            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3 mb-2 sm:mb-0">
                        <span class="text-2xl font-mono font-bold text-blue-600 bg-white px-3 py-1 rounded border">${code.code}</span>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900">Usage: ${code.usage_count} ${code.max_uses > 0 ? `/ ${code.max_uses}` : '(unlimited)'}</p>
                            <p class="text-xs text-gray-500">Created: ${createdDate}</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 mt-3 sm:mt-0 sm:ml-4">
                    <button onclick="copyInvitationCode('${code.code}')" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition-colors touch-target">
                        <i class="fas fa-copy mr-1"></i>Copy
                    </button>
                    <button onclick="shareInvitationCode('${code.code}')" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 transition-colors touch-target">
                        <i class="fas fa-share mr-1"></i>Share
                    </button>
                    <button onclick="deactivateInvitationCode('${code.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700 transition-colors touch-target">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            `;

            return div;
        }

        async function copyInvitationCode(code) {
            try {
                const shareText = `Join my fitness coaching program! Use invitation code: ${code}\n\nRegister at: ${window.location.origin}/signup.html?code=${code}`;
                
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(shareText);
                    alert('Invitation code and link copied to clipboard!');
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Invitation code copied to clipboard!');
                }
            } catch (error) {
                console.error('Copy failed:', error);
                alert(`Invitation code: ${code}\nManually copy this code to share with clients.`);
            }
        }

        async function shareInvitationCode(code) {
            const shareData = {
                title: 'Join My Fitness Program',
                text: `Join my fitness coaching program! Use invitation code: ${code}`,
                url: `${window.location.origin}/signup.html?code=${code}`
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    copyInvitationCode(code);
                }
            } catch (error) {
                console.error('Share failed:', error);
                copyInvitationCode(code);
            }
        }

        async function deactivateInvitationCode(codeId) {
            if (!confirm('Are you sure you want to delete this invitation code? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('invite_codes')
                    .update({ is_active: false })
                    .eq('id', codeId);

                if (error) {
                    throw error;
                }

                // Reload invitation codes
                loadInvitationCodes();
                alert('Invitation code deleted successfully.');

            } catch (error) {
                console.error('Error deactivating invitation code:', error);
                alert('Failed to delete invitation code. Please try again.');
            }
        }

        // Validate and process invitation codes during client registration
        async function validateInvitationCode(code) {
            try {
                // Use secure validation function
                const { data, error } = await window.supabaseClient
                    .rpc('validate_invitation_code', { input_code: code });

                if (error) {
                    console.error('Error validating invitation code:', error);
                    return { valid: false, message: 'Error validating invitation code' };
                }

                if (!data || data.length === 0) {
                    return { valid: false, message: 'Invalid or expired invitation code' };
                }

                const result = data[0];
                
                if (!result.is_valid) {
                    return { valid: false, message: 'Invalid or expired invitation code' };
                }

                return { 
                    valid: true, 
                    coach_email: result.coach_email,
                    coach_name: result.coach_name,
                    code_id: result.code_id
                };

            } catch (error) {
                console.error('Error validating invitation code:', error);
                return { valid: false, message: 'Error validating invitation code' };
            }
        }

        async function useInvitationCode(code) {
            try {
                // Use secure increment function
                const { data, error } = await window.supabaseClient
                    .rpc('increment_invitation_code_usage', { input_code: code });

                if (error) {
                    console.error('Error updating invitation code usage:', error);
                }
            } catch (error) {
                console.error('Error using invitation code:', error);
            }
        }

        // Initialize authentication
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Supabase to be ready
            const initializeAuth = () => {
                if (window.supabaseClient) {
                    loadCoachDashboard();
                } else {
                    setTimeout(initializeAuth, 100);
                }
            };

            initializeAuth();
        });
    </script>
</body>
</html>